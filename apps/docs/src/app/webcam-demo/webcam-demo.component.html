<div class="flex flex-col items-center justify-center">
	<div class="w-full overflow-auto mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
		<!-- Top Toolbar -->
		<p-toolbar
			styleClass="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 mb-5 shadow-sm">
			<div class="p-toolbar-group-left">
				<div class="flex items-center gap-3">
					<i class="pi pi-video text-gray-700 dark:text-gray-300"></i>
					<div class="flex-col flex gap-2 items-start">
						<h1 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-gray-100">
							Webcam Demo
						</h1>
						<p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400">
							TS-Webcam Library Showcase
						</p>
					</div>
				</div>
			</div>
			<div class="p-toolbar-group-right">
				<p-tag
					[severity]="
						uiState().isReady
							? 'success'
							: uiState().isLoading
							? 'warning'
							: uiState().isError
							? 'danger'
							: 'secondary'
					"
					[value]="
						uiState().isReady
							? 'Active'
							: uiState().isLoading
							? 'Starting…'
							: uiState().isError
							? 'Error'
							: 'Inactive'
					"></p-tag>
				<span class="ml-3 text-xs text-gray-400 dark:text-gray-500" aria-live="polite">
					({{ status() }})
				</span>
			</div>
		</p-toolbar>

		<!-- Permission Checking -->
		<div
			*ngIf="permissionState() === 'checking'"
			class="flex flex-col items-center justify-center min-h-[400px] text-center">
			<p-progressSpinner
				styleClass="w-12 h-12"
				strokeWidth="4"
				animationDuration="1s"></p-progressSpinner>
			<p class="mt-4 text-gray-600 dark:text-gray-400">Checking camera access permissions...</p>
		</div>

		<!-- Permission Denied -->
		<div
			*ngIf="permissionState() === 'denied' || permissionState() === 'prompt'"
			class="flex flex-col items-center justify-center min-h-[400px] text-center p-6">
			<div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-6 max-w-md">
				<div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 dark:bg-red-900/40 rounded-full">
					<i class="pi pi-exclamation-triangle text-red-600 dark:text-red-400 text-xl"></i>
				</div>
				<h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">
					{{ permissionState() === 'denied' ? 'Camera Access Not Permitted' : 'Camera Access Required' }}
				</h3>
				<p class="text-red-600 dark:text-red-300 text-sm mb-4">
					{{ permissionState() === 'denied' 
						? 'Please allow camera access in your browser settings or click the button below to try again' 
						: 'Please allow camera access to use this feature' }}
				</p>
				<div class="flex flex-col gap-3 justify-center">
					<div class="flex gap-2 justify-center">
						<p-button
							label="{{ permissionState() === 'denied' ? 'Try Again' : 'Request Permission' }}"
							icon="pi pi-refresh"
							(onClick)="retryPermissions()"
							severity="danger"
							size="small"></p-button>
						<p-button
							label="Check Status"
							icon="pi pi-search"
							(onClick)="checkPermissionState()"
							severity="secondary"
							size="small"></p-button>
					</div>
					<p-button
						label="Troubleshooting"
						icon="pi pi-question-circle"
						severity="help"
						size="small"
						(onClick)="showPermissionGuidance()"></p-button>
				</div>
			</div>
		</div>

		<!-- Main Interface -->
		<div
			*ngIf="permissionState() === 'granted'"
			class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
			<!-- Left: Video -->
			<p-card
				styleClass="lg:col-span-2 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm">
				<ng-template pTemplate="content">
					<!-- Video Area -->
					<div class="relative bg-black/90 rounded-lg overflow-hidden aspect-video mb-4">
						<!-- Skeleton while loading -->
						<div *ngIf="uiState().isLoading" class="absolute inset-0">
							<div class="w-full h-full">
								<p-skeleton styleClass="w-full h-full !rounded-none"></p-skeleton>
							</div>
						</div>

						<video
							#videoElement
							autoplay
							playsinline
							muted
							[class]="
								[
									'w-full h-full object-contain transition-transform duration-300',
									enableMirror() ? 'scale-x-[-1]' : ''
								].join(' ')
							"></video>

						<!-- Placeholder -->
						<div
							*ngIf="!uiState().isReady && !error()"
							class="absolute inset-0 flex flex-col items-center justify-center text-gray-300 dark:text-gray-600">
							<i class="pi pi-video text-4xl mb-2"></i>
							<p class="text-xs sm:text-sm">Start camera to see video stream</p>
						</div>

						<!-- Error -->
				<div
					*ngIf="error() && permissionState() === 'granted'"
					class="absolute inset-0 flex flex-col items-center justify-center bg-red-900/80 text-white p-6 text-center">
							<i class="pi pi-times-circle text-3xl mb-2"></i>
							<h4 class="font-semibold text-lg sm:text-xl mb-2">Error while starting camera</h4>
							<p class="text-xs sm:text-sm opacity-90 mb-2">
								{{ getCurrentCameraName() || "Unknown device" }} •
								{{ selectedResolution().width }}×{{ selectedResolution().height }}
							</p>
							<pre class="text-xs whitespace-pre-wrap max-w-full">{{ error() }}</pre>
						</div>

						<!-- Floating Controls -->
						<div class="absolute right-2 top-2 flex gap-2">
							<p-button
								[rounded]="true"
								[text]="true"
								pTooltip="Test Capabilities"
								[disabled]="!selectedDevice()"
								(onClick)="testDeviceCapabilities()"></p-button>
						</div>
					</div>

					<!-- Primary Actions -->
					<div class="flex flex-wrap justify-center gap-2 sm:gap-3">
						<p-button
							label="Start"
							[disabled]="!uiState().canStart"
							(onClick)="startCamera()"></p-button>
						<p-button
							label="Capture"
							[disabled]="!uiState().canCapture"
							(onClick)="captureImage()"></p-button>
						<p-button
							label="Stop"
							[disabled]="!uiState().canStop"
							(onClick)="stopCamera()"
							severity="danger"></p-button>
					</div>

					<!-- Captured Image -->
					<p-panel
						*ngIf="capturedImageUrl()"
						class="mt-5"
						[toggleable]="true"
						[collapsed]="false"
						header="Captured Image">
						<ng-template pTemplate="icons">
							<p-button
								label="Clear"
								size="small"
								severity="danger"
								(onClick)="clearCapturedImage()"></p-button>
						</ng-template>
						<div class="flex justify-center">
							<img
								[src]="capturedImageUrl()"
								alt="Captured"
								class="max-w-full h-auto rounded-lg border border-gray-200 dark:border-gray-700" />
						</div>
					</p-panel>
				</ng-template>
			</p-card>

			<!-- Right: Settings -->
			<div class="space-y-4">
				<p-card
					header="Quick Controls"
					styleClass="border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm">
					<ng-template pTemplate="content">
						<div class="grid grid-cols-1 gap-3">
							<div class="flex items-center justify-between">
								<span class="text-xs sm:text-sm text-gray-700 dark:text-gray-300">
									Mirror Video
								</span>
								<p-toggleswitch [(ngModel)]="enableMirror" [disabled]="uiState().isLoading" />
							</div>
							<div class="flex items-center justify-between">
								<span class="text-xs sm:text-sm text-gray-700 dark:text-gray-300">Audio</span>
								<p-toggleswitch [(ngModel)]="enableAudio" [disabled]="uiState().isLoading" />
							</div>

							<div class="col-span-2" *ngIf="webcamService.deviceCapability()?.hasTorch">
								<div class="flex items-center justify-between">
									<span class="text-xs sm:text-sm text-gray-700 dark:text-gray-300">Torch</span>
									<p-inputSwitch
										[(ngModel)]="enableTorch"
										[disabled]="!uiState().isReady"></p-inputSwitch>
								</div>
							</div>

							<div
								class="col-span-2"
								*ngIf="
									webcamService.deviceCapability()?.hasZoom &&
									minZoom() !== null &&
									maxZoom() !== null
								">
								<p class="block text-xs sm:text-sm text-gray-700 dark:text-gray-300 mb-1">
									Zoom ({{ zoomValue() }}x)
								</p>
								<p-slider
									[(ngModel)]="zoomValue"
									[min]="minZoom()"
									[max]="maxZoom()"
									[step]="0.1"
									[disabled]="!uiState().isReady"></p-slider>
							</div>

							<div
								class="col-span-2"
								*ngIf="webcamService.deviceCapability()?.hasFocus && supportedFocusModes().length">
								<p class="block text-xs sm:text-sm text-gray-700 dark:text-gray-300 mb-1">
									Focus Mode
								</p>
								<p-select
									[options]="supportedFocusModes()"
									[(ngModel)]="focusMode"
									placeholder="Select"
									styleClass="w-full"></p-select>
							</div>
						</div>
					</ng-template>
				</p-card>

				<p-card
					header="Device & Resolution"
					class="border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm">
					<ng-template pTemplate="content">
						<div class="space-y-4">
							<div>
								<p
									class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
									Camera
								</p>
								<p-select
									[options]="devices()"
									[(ngModel)]="selectedDevice"
									[disabled]="uiState().isLoading"
									placeholder="Select Camera"
									optionLabel="label"
									class="w-full"
									(onChange)="onDeviceChange($event.value)">
									<ng-template pTemplate="selectedItem" let-sd>
										{{ sd?.label || "Camera " + sd?.deviceId?.slice(0, 8) + "..." }}
									</ng-template>
									<ng-template pTemplate="item" let-d>
										{{ d.label || "Camera " + d.deviceId.slice(0, 8) + "..." }}
									</ng-template>
								</p-select>
							</div>

							<div>
								<p
									class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
									Resolution
								</p>

								<p-select
									[options]="resolutions"
									[(ngModel)]="selectedResolution"
									placeholder="Select Resolution"
									optionLabel="label"
									class="w-full"
									(onChange)="onResolutionChange($event)">
									<ng-template pTemplate="selectedItem" let-sr>
										{{ sr?.label }} ({{ sr?.width }}×{{ sr?.height }})
									</ng-template>
									<ng-template pTemplate="item" let-r>
										{{ r.label }} ({{ r.width }}×{{ r.height }})
									</ng-template>
								</p-select>
							</div>
						</div>
					</ng-template>
				</p-card>

				<p-card
					header="Diagnostics"
					styleClass="border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm">
					<ng-template pTemplate="content">
						<div class="text-xs sm:text-sm space-y-2">
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Device Type</span>
								<span class="font-medium text-gray-900 dark:text-gray-100">
									{{ getDeviceType() }}
								</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Current Camera</span>
								<span
									class="font-medium text-right max-w-[220px] truncate text-gray-900 dark:text-gray-100"
									[title]="getCurrentCameraName()">
									{{ getCurrentCameraName() }}
								</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Resolution</span>
								<span class="font-medium text-gray-900 dark:text-gray-100">
									{{ selectedResolution().width }}×{{ selectedResolution().height }}
								</span>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Torch</span>
								<p-tag
									[severity]="webcamService.isTorchSupported() ? 'success' : 'secondary'"
									[value]="webcamService.isTorchSupported() ? 'Available' : 'N/A'"></p-tag>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Zoom</span>
								<p-tag
									[severity]="webcamService.isZoomSupported() ? 'success' : 'secondary'"
									[value]="webcamService.isZoomSupported() ? 'Available' : 'N/A'"></p-tag>
							</div>
							<div class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Focus</span>
								<p-tag
									[severity]="webcamService.isFocusSupported() ? 'success' : 'secondary'"
									[value]="webcamService.isFocusSupported() ? 'Available' : 'N/A'"></p-tag>
							</div>
							<div *ngIf="enableAudio()" class="flex justify-between">
								<span class="text-gray-600 dark:text-gray-400">Audio</span>
								<p-tag severity="info" value="Enabled"></p-tag>
							</div>
						</div>

						<p-divider></p-divider>

						<div class="flex flex-col gap-2">
							<div class="flex gap-2">
								<p-button
									label="Find Front Camera"
									(onClick)="testSelectDevice('front')"
									size="small"></p-button>
								<p-button
									label="Find Back Camera"
									(onClick)="testSelectDevice('back')"
									size="small"></p-button>
							</div>

							<p-button
								label="Test Current Device Capabilities"
								size="small"
								[disabled]="!selectedDevice()"
								(onClick)="testDeviceCapabilities()"></p-button>
						</div>

						<p-panel
							*ngIf="selectDeviceDetails()"
							header="Last Tested (Selection)"
							[toggleable]="true"
							class="mt-3">
							<div class="bg-gray-100 dark:bg-gray-800 rounded p-2 overflow-x-auto">
								<pre class="text-xs text-gray-700 dark:text-gray-300">{{
									selectDeviceDetails() | json
								}}</pre>
							</div>
						</p-panel>

						<p-panel
							*ngIf="webcamService.deviceCapability()"
							header="Last Tested (Capabilities)"
							[toggleable]="true"
							class="mt-3">
							<div class="bg-gray-100 dark:bg-gray-800 rounded p-2 overflow-x-auto">
								<pre class="text-xs text-gray-700 dark:text-gray-300">{{
									webcamService.deviceCapability() | json
								}}</pre>
							</div>
						</p-panel>
					</ng-template>
				</p-card>
			</div>
		</div>

		<!-- Toast for subtle feedback -->
		<p-toast
			position="top-center"
			[baseZIndex]="9999"
			[breakpoints]="{
				'920px': { width: '100%', padding: '0px 16px' }
			}" />
	</div>
</div>
